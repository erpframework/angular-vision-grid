"use strict";angular.module("vision.grid",["vision.grid.util"]).directive("columnSort",[function(){return{require:"^grid",restrict:"E",templateUrl:"template/vision/grid/column-sort.html"}}]).directive("visionCell",[function(){return{require:"^visionGrid",replace:"A",link:function(a,b,c){if(a.column.editable){var d=c.rowIndex+c.colIndex;a.cells[d]={rowIndex:parseInt(c.rowIndex),colIndex:parseInt(c.colIndex),element:b,column:a.column}}a.hasFocus=function(b,c){return String(b)+String(c)==a.cellIndex.current.position}}}}]).directive("gridEditor",["$compile",function(a){return{require:"^visionGrid",replace:"A",link:function(b,c,d){d.ngModel||(c.attr("ng-model","row.item."+b.column.fieldName),a(c)(b))}}}]).directive("visionGrid",["vsGridUtil","$filter","$timeout","$window","$animate",function(a,b,c,d){return{restrict:"E",replace:!0,templateUrl:"template/vision/grid/vision-grid.html",transclude:!0,scope:{init:"&",provider:"=?",sortFunction:"&",onSelect:"&",itemDoubleClick:"&",cellBlur:"&",height:"@",selectionMode:"@",headerHeight:"@",groupHeaderHeight:"@",rowHeight:"@",rowColorFunction:"&",rowColorField:"@",scrollOffset:"@",headerBar:"@",footerBar:"@",expandRowUrl:"@",expandColumnHeader:"@",expandColumnRenderer:"@",toggleExpandRow:"=?",virtualScrollEnabled:"=?",minRows:"@"},controller:["$scope","$element","$attrs",function(a){this.nextCell=function(){a.goToCell(a.cellIndex.current.colIndex+1)},this.previousCell=function(){a.goToCell(a.cellIndex.current.colIndex-1)},this.addColumnsGroup=function(b){this.addColumnsGroupAt(a.columns.length,b)},this.addColumnsGroupAt=function(b,c){for(var d=c.getColumns(),e=0;e<d.length;e++){if(!angular.isDefined(d[e].fieldName))throw"When adding gridColumn, fieldName is required!";d[e].indexInTheGroup=e,a.addColumnAt(b+e,d[e])}},this.addColumn=function(b){if(null!=b.getGroup())throw"When adding grouped gridColumns, use the addColumnsGroup or addColumnsGroupAt functions!";this.addColumnAt(a.columns.length,b)},this.addColumnAt=function(b,c){if(!angular.isDefined(c.fieldName))throw"When adding gridColumn, fieldName is required!";if(null!=c.getGroup())throw"When adding grouped gridColumns, use the addColumnsGroup or addColumnsGroupAt functions!";a.addColumnAt(b,c)},this.getColumnByFieldName=function(b){for(var c=0;c<a.columns.length;c++)if(a.columns[c].fieldName==b)return a.columns[c]},this.getColumn=function(b){return a.columns[b]},this.getColumns=function(){return a.columns},this.setProvider=function(b){a.provider=b},this.getSelectedItem=function(){return a.selectedItem},this.getColumnSelected=function(){return a.columnSelected},this.setHeight=function(b){a.updateHeight(b)},this.getGridName=function(){return a.gridName},this.setExpandRowUrl=function(b){a.setExpandRowUrl(b)},this.setOuterScope=function(b){a.outerScope=b},this.setSortFunction=function(b){a.sortFunction=b}}],link:function(e,f,g,h){var i=d.navigator.userAgent.toLowerCase(),j=i.indexOf("firefox")>-1,k=i.indexOf("opera")>-1,l=j?224:k?17:91;e.outerScope=e.$parent,e.cells={},e.editableColumns=[],e.toggleExpandRow=a.getDefined(e.toggleExpandRow,!0),e.gridName=a.getDefined(g.name,"grid"),angular.element(f[0].parentElement).scope()[e.gridName]=h,e.gridProvider=[],e.renderedProvider=[],e.viewPortStyle={},e.tablePortStyle={},e.tablePortStyle.position="relative",e.columns=[],e.containsGroupedColumns=!1;var m,n,o,p,q,r;e.minRows=a.getDefined(e.minRows,"0"),m=Number(e.minRows),e.headerHeight=a.getDefined(e.headerHeight,"30px"),n=Number(e.headerHeight.replace("px","")),e.headerStyle={},e.headerStyle.height=e.headerHeight,e.headerStyle.width="100%",e.groupHeaderHeight=a.getDefined(e.groupHeaderHeight,"15px"),o=Number(e.groupHeaderHeight.replace("px","")),e.groupHeaderStyle={},e.groupHeaderStyle.height=e.groupHeaderHeight,e.groupHeaderStyle.width="100%",e.groupedColumnsHeaderStyle={},e.groupedColumnsHeaderStyle.height=n-o+"px",e.groupedColumnsHeaderStyle.width="100%",g.rowHeight=a.getDefined(e.rowHeight,"30px"),q=Number(g.rowHeight.replace("px","")),g.height=a.getDefined(g.height,"300px"),p=Number(g.height.replace("px","")),e.styleContainer={},e.styleContainerInner={},e.virtualScrollEnabled&&(e.styleContainer.height=g.height,e.styleContainerInner.height=p-n+"px");var s,t,u=f.find(".fixed-table-container-inner"),v=null,w=null,x=f.find(".table-header"),y=(f.find("#vs-grid-spinner"),u[0]);u.scroll(function(){null==v&&null==w?(v=f.find(".vs-header-bar"),w=f.find(".vs-footer-bar")):(v.offset({left:-1*this.scrollLeft+u.offset().left}),w.offset({left:-1*this.scrollLeft+u.offset().left})),x.offset({left:-1*this.scrollLeft+u.offset().left}),e.virtualScrollEnabled&&(s=Math.ceil(y.scrollTop/q),t=Math.ceil((y.scrollTop+y.offsetHeight)/q),y.scrollTop+y.offsetHeight<=r&&(e.tablePortStyle.top=y.scrollTop+"px",e.renderProvider(e.gridProvider.slice(s,t)),e.$digest()))}),e.scrollToRowIndex=function(a){c(function(){s>a?(y.scrollTop-=q,u.scroll()):a+1>t&&(y.scrollTop+=q,u.scroll())})};var z=function(){return e.virtualScrollEnabled?Math.ceil((p-n)/q):e.gridProvider.length};e.updateHeight=function(a){p=a,e.styleContainer.height=p+"px",e.styleContainerInner.height=p-n+"px",e.renderProvider(e.gridProvider,z()),e.$apply()},e.renderProvider=function(a,b){void 0==b&&(b=a.length),e.renderedProvider.length=b;for(var c=0;b>c||m>c;c++)e.renderedProvider[c]=angular.isDefined(a[c])?{isRendered:!0,item:a[c]}:{}},e.$watchCollection("provider",function(a,b){E(),e.gridProvider=[],null!=e.provider&&void 0!=e.provider&&angular.extend(e.gridProvider,e.provider),e.virtualScrollEnabled&&angular.isDefined(a)&&a.length>0&&(r=a.length*q,e.viewPortStyle.height=r+"px"),(void 0==b||void 0==a||a.length!=b.length)&&c(function(){y.scrollTop=0,u.scroll()})}),e.$watchCollection("gridProvider",function(){e.renderProvider(e.gridProvider,z()),s=0,t=e.renderedProvider.length}),e.getRowStyle=function(b){var c={};if(c.height=e.rowHeight,angular.isDefined(e.rowColorField)){var d=a.evaluate(b,e.rowColorField);angular.isDefined(d)&&(c.backgroundColor=d)}if(angular.isDefined(g.rowColorFunction)){var d=e.rowColorFunction({$item:b});angular.isDefined(d)&&(c.backgroundColor=d)}return c},e.getColumnStyle=function(a,b){var c={};if("header"==b?c.textAlign=a.headerTextAlign:"group-header"!=b&&(c.textAlign=a.textAlign),"group-header"==b){c.textAlign="center";for(var d=0,e=!1,f=a.getGroup().getColumns(),g=0;g<f.length;g++)angular.isDefined(f[g].width)?d+=Number(f[g].width.replace("px","")):(d+=80,e=!0);e?(c.minWidth=d+"px",c.width="auto !important"):c.width=d+"px"}else angular.isDefined(a.width)?c.width=a.width:(c.minWidth="80px",c.width="auto !important");return c},e.addColumnAt=function(b,c){e.containsGroupedColumns||null==c.getGroup()||(e.containsGroupedColumns=!0),c.index=b,c instanceof GridColumnDecimal&&!angular.isDefined(c.labelFunction)&&(c.labelFunction=a.formatDecimal),c instanceof GridColumnDate&&!angular.isDefined(c.labelFunction)&&(c.labelFunction=a.formatDate),c instanceof GridColumnEnum&&!angular.isDefined(c.labelFunction)&&(c.labelFunction=a.formatEnum),c.editable&&e.editableColumns.push(c),e.$emit("grid:addColumn",c),e.columns.splice(b,0,c)},e.getItem=function(b,c,d){var e;return e=angular.isFunction(d.labelFunction)?d.labelFunction(c,d,b):a.evaluate(c,d.fieldName),void 0!=e?e.toString():""},e.isHeaderRenderer=function(a){return angular.isDefined(a.headerRenderer)},e.isItemRenderer=function(a,b){return angular.isDefined(b.itemRenderer)},e.selectItemDblclick=function(a,b){e.selectItem(a,b),g.itemDoubleClick&&e.itemDoubleClick({$data:e.getData()}),e.$emit(e.gridName+":itemDoubleClick",e.getData())},e.selectedItems=[],g.selectionMode=a.getDefined(e.selectionMode,"single");var A,B,C,D=-1;e.selectItem=function(a,b){if(e.columnSelected=b,angular.isDefined(a)){if(e.selectedIndex=e.provider.indexOf(a),C=e.gridProvider.indexOf(a),e.selectedItem=a,e.shiftKey)-1==D&&(D=C,e.selectedItems=[]),C>D?(A=D,B=C):(A=C,B=D),e.selectedItems=e.gridProvider.slice(A,B+1);else if(e.ctrlKey){if(-1==e.selectedItems.indexOf(a))e.selectedItems.push(a);else{var c=e.selectedItems.indexOf(a);e.selectedItems.splice(c,1)}D=C}else D=C,e.selectedItems=[a];angular.isDefined(g.onSelect)&&e.onSelect({$data:e.getData()}),e.$emit(e.gridName+":onSelect",e.getData())}},e.getData=function(){var a={};return a.selectedIndex=e.selectedIndex,a.selectedItem=e.selectedItem,a.columnSelected=e.columnSelected,a.selectedItems=e.selectedItems,a};var E=function(){e.selectedItems=[],e.selectedItem=null,e.selectedIndex=null,e.selectedColumn=null};e.selectClass=function(a){return a&&(a==e.selectedItem&&"single"==e.selectionMode||-1!=e.selectedItems.indexOf(a)&&"multiple"==e.selectionMode)?"selected-item":""},e.onKeyDown=function(a){9==a.keyCode&&(a.shiftKey?h.previousCell():h.nextCell(),a.preventDefault()),(38==a.keyCode||40==a.keyCode)&&(void 0==C&&(C=-1),38==a.keyCode&&(0>C?C=0:C>0&&C--),40==a.keyCode&&(C>e.gridProvider.length?C=e.gridProvider.length:C<e.gridProvider.length&&C++),e.selectItem(e.gridProvider[C],e.selectedColumn),e.scrollToRowIndex(C)),"multiple"==e.selectionMode&&(e.shiftKey=a.shiftKey,e.ctrlKey=a.ctrlKey||a.keyCode==l),e.$emit(e.gridName+":onKeyDown",a)},e.cellIndex={current:{rowIndex:-1,colIndex:-1,position:"-1"}},e.cellIndex.old=e.cellIndex.current,e.goToCell=function(a){void 0==C&&(C=-1),-1==e.cellIndex.current.rowIndex&&(e.cellIndex.current.rowIndex=0,e.cellIndex.current.colIndex=0);var b=e.cellIndex.current.rowIndex;0>a?(C--,b--,a=e.editableColumns[e.editableColumns.length-1].index):a>e.editableColumns.length-1&&(C++,b++,a=e.editableColumns[0].index);var d=String(b)+String(e.editableColumns[a].index),f=e.cells[d];f?(g.cellBlur&&e.cellIndex.old!=e.cellIndex.current&&e.cellBlur({$data:{oldCell:e.cells[e.cellIndex.old.position],cell:e.cells[e.cellIndex.current.position],selectedItem:e.getData().selectedItem}}),e.cellIndex.old=e.cellIndex.current,e.cellIndex.current.rowIndex=b,e.cellIndex.current.colIndex=a,e.cellIndex.current.position=d,c(function(){angular.element(f.element).find("input")[0].focus()})):b>e.renderedProvider.length-1&&(e.scrollToRowIndex(C),e.goToCell(0))},e.onKeyUp=function(a){"multiple"==e.selectionMode&&(e.shiftKey=a.shiftKey,e.ctrlKey=a.ctrlKey,a.keyCode==l&&(e.ctrlKey=!1)),e.$emit(e.gridName+":onKeyUp",a)},e.sort={sortingField:null,reverse:!1},e.selectSorterClass=function(a){return a==e.sort.sortingField?"glyphicon glyphicon-chevron-"+(e.sort.reverse?"down":"up"):""},angular.isDefined(g.sortFunction)||(e.sortFunction=void 0),e.sortBy=function(a){e.sort.sortingField==a&&(e.sort.reverse=!e.sort.reverse),e.sort.sortingField=a,angular.isDefined(e.sortFunction)?e.sortFunction({$sort:e.sort}):e.gridProvider=b("orderBy")(e.provider,e.sort.sortingField,e.sort.reverse)},e.hasHeaderBar=function(){return angular.isDefined(g.headerBar)},e.hasFooterBar=function(){return angular.isDefined(g.footerBar)};var F={};e.getHeaderFooterStyle=function(){return F.width=u[0].scrollWidth,F},e.openCloseExpandRow=function(a){a.expandRowOpened=!a.expandRowOpened,e.toggleExpandRow&&angular.forEach(e.renderedProvider,function(b){b!=a&&(b.expandRowOpened=!1)})},e.expandRow=void 0,e.setExpandRowUrl=function(b){e.expandRow=b,g.expandColumnRenderer=a.getDefined(e.expandColumnRenderer,"template/vision/grid/expandColumnRenderer.html");var c=new GridColumn;c.fieldName="expandColumn",c.width="70px",c.textAlign="center",c.itemRenderer=g.expandColumnRenderer,angular.isDefined(e.expandColumnHeader)&&(c.headerText=e.expandColumnHeader),e.addColumnAt(0,c)},angular.isDefined(e.expandRowUrl)&&e.setExpandRowUrl(e.expandRowUrl),angular.isDefined(g.init)&&(e.init({$ctrl:h}),c(function(){e.$emit(e.gridName+":init",{$ctrl:h})}))}}}]).run(["$templateCache",function(a){a.put("template/vision/grid/vision-grid.html",'<div class="row">\n    <div class="vs-grid col-sm-12">\n        <div class="header-footer" ng-if="hasFooterBar()">\n            <div class="vs-header-bar" ng-include="headerBar" ng-style="getHeaderFooterStyle()"></div>\n        </div>\n        <div class="fixed-table-container" ng-style="styleContainer" class="table table-bordered" tabindex="0" ng-keydown="onKeyDown($event)" ng-keyup="onKeyUp($event)">\n            <div class="table-header">\n                <table class="table-bordered table-vision">\n                    <thead>\n                        <tr>\n                           <th ng-repeat="column in columns track by $index"\n                               ng-if="column.getGroup() == null || column.indexInTheGroup == 0"\n                               class="vs-grid-column"\n                               rowspan="{{!containsGroupedColumns || column.getGroup() != null ? 1 : 2}}"\n                               colspan="{{!containsGroupedColumns || column.getGroup() == null ? 1 : column.getGroup().getColumns().length}}"\n                               ng-show="column.getGroup() == null ? column.visible : column.getGroup().visible"\n                               ng-style="getColumnStyle(column, column.getGroup() == null ? \'header\' : \'group-header\')"\n                               ng-class="{first: $first}">\n                                   <div ng-style="column.getGroup() == null ? headerStyle : groupHeaderStyle" ng-show="isHeaderRenderer(column.getGroup() == null ? column : column.getGroup())" ng-include="column.getGroup() == null ? column.headerRenderer : column.getGroup().headerRenderer"></div>\n                                   <div ng-style="column.getGroup() == null ? headerStyle : groupHeaderStyle" ng-show="!isHeaderRenderer(column.getGroup() == null ? column : column.getGroup())">\n                                       <span ng-show="column.getGroup() != null || !column.sortable" ng-bind="column.getGroup() == null ? column.headerText : column.getGroup().headerText"></span>\n                                       <column-sort ng-if="column.getGroup() == null && column.sortable"></column-sort>\n                                   </div>\n                            </th>\n                        </tr>\n                        <tr ng-if="containsGroupedColumns">\n                           <th ng-repeat="column in columns track by $index"\n                               ng-if="column.getGroup() != null"\n                               class="vs-grid-column"\n                               ng-style="getColumnStyle(column, \'header\')"\n                               ng-class="{first: $first}">\n                                   <div ng-style="groupedColumnsHeaderStyle" ng-show="isHeaderRenderer(column)" ng-include="column.headerRenderer"></div>\n                                   <div ng-style="groupedColumnsHeaderStyle" ng-show="!isHeaderRenderer(column)">\n                                       <span ng-show="!column.sortable" ng-bind="column.headerText"></span>\n                                       <column-sort ng-if="column.sortable"></column-sort>\n                                   </div>\n                            </th>\n                        </tr>\n                    </thead>\n               </table>\n            </div>\n            <div class="fixed-table-container-inner" ng-style="styleContainerInner">\n                <div ng-style="viewPortStyle" style="position: relative; display: block;">\n                    <table class="table table-bordered table-vision" ng-style="tablePortStyle">\n                        <tbody>\n                           <!--tabindex="{{$parent.$parent.$index}}{{$index+1}}"-->\n                           <tr ng-repeat-start="row in renderedProvider track by $index"\n                               ng-init="row.item"\n                               ng-class="{rendered:row.isRendered}"\n                               ng-style="getRowStyle(row.item)">\n                               <td ng-repeat="column in columns track by $index"\n                                   ng-show="column.visible" \n                                   ng-mousedown="selectItem(row.item, column)"\n                                   ng-dblclick="selectItemDblclick(row.item, column)"\n                                   ng-class="selectClass(row.item)"\n                                   vision-cell row-index="{{$parent.$index}}" col-index="{{$index}}"\n                                   ng-style="getColumnStyle(column)">\n                                     <div ng-show="hasFocus($parent.$index, $index)" tabindex="-1"><input type="text" grid-editor style="width: 100%"></div>\n                                     <span ng-show="!isItemRenderer(row.item, column) && !hasFocus($parent.$index, $index)" ng-bind-html="getItem($parent.$index, row.item, column)"></span>\n                                     <div ng-show="isItemRenderer(row.item, column)" ng-include="column.itemRenderer"></div>\n                               </td>\n                           </tr>\n                           <tr class="actions text-left" ng-show="row.expandRowOpened" ng-repeat-end>\n                               <td ng-include="expandRow" colspan="{{columns.length}}" ></td>\n                           </tr>\n                       </tbody>\n                   </table>\n               </div>\n           </div>\n       </div>\n       <div class="header-footer" ng-if="hasFooterBar()">\n           <div class="vs-footer-bar" ng-include="footerBar" ng-style="getHeaderFooterStyle()"></div>\n       </div>\n   </div>\n</div>'),a.put("template/vision/grid/column-sort.html",'<a ng-click="sortBy(column.fieldName)">\n   <span ng-bind="column.headerText"></span>\n   <i ng-class="selectSorterClass(column.fieldName)"></i>\n</a>'),a.put("template/vision/grid/expandColumnRenderer.html",'<a class="expand-row" ng-click="openCloseExpandRow(row)">\n   <i class="fa" ng-class="{\'fa-chevron-right\': !row.expandRowOpened, \'fa-chevron-down\': row.expandRowOpened}"></i>\n</a>')}]),angular.module("vision.grid.util",[]).factory("vsGridUtil",["$filter","$locale",function(a,b){var c=function(a,c,d,e,f){var g="";a&&(g=b.NUMBER_FORMATS.CURRENCY_SYM+" "),void 0==f&&(f=b.NUMBER_FORMATS.GROUP_SEP),void 0==e&&(e=b.NUMBER_FORMATS.DECIMAL_SEP);var h,i=c,j=isNaN(d)?2:Math.abs(d),k=e||".",l="undefined"==typeof f?",":f,m=0>i?"-":"",n=parseInt(i=Math.abs(i).toFixed(j))+"";return h=(h=n.length)>3?h%3:0,g+m+(h?n.substr(0,h)+l:"")+n.substr(h).replace(/(\d{3})(?=\d)/g,"$1"+l)+(j?k+Math.abs(i-n).toFixed(j).slice(2):"")},d=function(){};return d.getValueOfLabelField=function(a,b,c,e){if(null!=e){var f=d.getItemByPropertyValue(a,c,e);return d.evaluate(f,b)}return null},d.getItemByPropertyValue=function(a,b,c){var e=d.getItemIndexByPropertyValue(a,b,c);return-1==e?null:a[e]},d.getItemIndexByPropertyValue=function(a,b,c){if(angular.isDefined(c)&&null!=a)for(var e,f,g=0;g<a.length;g++)if(f=a[g],e=d.evaluate(f,b),e=null!=e?String(e).toLowerCase():null,c=String(c).toLowerCase(),e==c)return g;return-1},d.getDefined=function(a,b){return angular.isDefined(a)?a:b},d.evaluate=function(a,b){var c=b.split("."),d=a;for(var e in c)null!=d&&(d=d[c[e]]);return d},d.formatDecimal=function(a,b){var e=d.evaluate(a,b.fieldName);return angular.isDefined(e)?c(b.useSymbol,e,b.centsLimit,b.decimalSeparator,b.thousandsSeparator):""},d.formatDate=function(b,c){var e=d.evaluate(b,c.fieldName);return"string"==typeof e&&(e=new Date(moment(e,"YYYY-MM-DD HH:mm:ss.SSS").toISOString())),a("date")(e,c.format)},d.formatEnum=function(a,b){var c=d.evaluate(a,b.fieldName);return c=d.getValueOfLabelField(b.provider,b.labelField,b.labelValue,c),null==c?"":String(c)},d.formatEntity=function(a,b){var c=b.fieldName.split(".");return c.splice(c.length-1,1,b.labelField),d.evaluate(a,c.join("."))},d}]);var GridColumn=function(a,b,c){this.headerText=a,this.fieldName=b,this.sortable=!0,this.labelFunction=void 0,this.headerRenderer=void 0,this.itemRenderer=void 0,this.editable=!1,this.itemEditor=void 0,this.width=c,this.headerTextAlign="left",this.textAlign="left",this.visible=!0;var d=null,e=!1;this.setGroup=function(a){e?d=a:(e=!0,null!=d&&d.removeColumn(this),null!=a&&a.removeColumn(this),null!=a&&a.addColumn(this),e=!1)},this.getGroup=function(){return d}},GridColumnsGroup=function(a){this.headerText=a;var b=[];this.addColumn=function(a){b.indexOf(a)<0&&(b.push(a),a.setGroup(this))},this.removeColumn=function(a){var c=b.indexOf(a);c>=0&&(b.splice(c,1),a.setGroup(null))},this.getColumns=function(){return angular.extend([],b)},this.headerRenderer=void 0,this.visible=!0},GridColumnDecimal=function(a,b,c){GridColumn.call(this,a,b,c),this.textAlign="right",this.centsLimit=2,this.centsSeparator=",",this.thousandsSeparator=".",this.useSymbol=!1};GridColumnDecimal.prototype=new GridColumn;var GridColumnDate=function(a,b,c){GridColumn.call(this,a,b,c),this.format="dd/MM/yyyy"};GridColumnDate.prototype=new GridColumn;var GridColumnEnum=function(a,b,c){GridColumn.call(this,a,b,c),this.labelField=void 0,this.labelValue=void 0,this.provider=[]};GridColumnEnum.prototype=new GridColumn;